<!DOCTYPE html>
<html>
  <head>
    <title>Hybrid AI App</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      #chatOutput {
        max-height: 500px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 15px;
        background: #fff;
        border-radius: 8px;
      }
      .user-msg {
        font-weight: bold;
        margin-bottom: 5px;
      }
      .bot-msg {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container mt-5">
      <h1 class="mb-3 text-center">ü§ñ AI Friend App</h1>
      <p class="lead text-center">{{ greeting }}</p>

      <div class="input-group mb-3">
        <input
          type="text"
          id="userInput"
          class="form-control"
          placeholder="Ask me anything..."
        />
        <button class="btn btn-primary" onclick="sendMessage()">Send</button>
        <button class="btn btn-secondary" onclick="startListening()">üé§</button>
      </div>

      <div id="chatOutput" class="mt-4"></div>
    </div>

    <script>
      function sendMessage() {
        const userInput = document.getElementById("userInput").value;
        const chatOutput = document.getElementById("chatOutput");

        if (!userInput.trim()) return;

        fetch("/ask", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: `message=${encodeURIComponent(userInput)}`,
        })
          .then((res) => res.json())
          .then((data) => {
            const messageBlock = `
              <div class="mb-3">
                <div class="user-msg">You: ${userInput}</div>
                <div class="bot-msg"><strong>Bot:</strong> <span>${data.response}</span></div>
              </div>
            `;
            chatOutput.innerHTML += messageBlock;
            document.getElementById("userInput").value = "";
            chatOutput.scrollTop = chatOutput.scrollHeight;

            // üó£Ô∏è Text-to-Speech
            const cleanResponse = data.response.replace(/<[^>]*>?/gm, '');
            const utterance = new SpeechSynthesisUtterance(cleanResponse);
            speechSynthesis.speak(utterance);
          });
      }

      // üé§ Speech-to-Text
      function startListening() {
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'en-US';
        recognition.onresult = function (event) {
          const transcript = event.results[0][0].transcript;
          document.getElementById("userInput").value = transcript;
          sendMessage(); // Auto-send after speaking
        };
        recognition.start();
      }
    </script>
  </body>
</html>
